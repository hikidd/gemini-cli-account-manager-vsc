# Gemini CLI Account Manager - 实现计划

VSCode 插件，管理多个 Google 账号的 Gemini CLI 凭证，支持一键切换账号。

## OAuth 配置

*   **Client ID**: `YOUR_CLIENT_ID`
*   **Client Secret**: `YOUR_CLIENT_SECRET`
*   **Redirect URI**: `http://localhost:8085/oauth2callback`
*   **Scopes**: `cloud-platform`, `userinfo.email`, `userinfo.profile`

## 配额功能说明

WARNING

**调研结论**：Gemini API **不提供**直接查询剩余配额的接口。

*   API 响应头不含 `X-RateLimit-Remaining` 类似字段
*   只有超限时返回 429 + `Retry-After`
*   Cloud Monitoring API 可用但配置复杂（需额外启用 Monitoring API）

**建议**：第一版暂不实现配额功能，专注核心的账号管理和切换。后期如需配额：

*   方案 A：接入 Cloud Monitoring API（复杂）
*   方案 B：本地计数器统计请求次数（简单但不精确）

***

## UI 设计要求

参考用户提供的截图，每个账号卡片需显示：

| 列    | 内容                                 |
| :--- | :--------------------------------- |
| 邮箱   | 账号邮箱 + 类型徽章（PRO/FREE）              |
| 模型配额 | 显示两个模型卡片：**G3 Pro** 和 **G3 Flash** |
| 最后使用 | 时间戳                                |
| 操作   | 查看、切换、刷新按钮                         |

### 模型列表（固定显示）

    const MODELS = [  { name: 'gemini-3-pro-preview', displayName: 'G3 Pro' },  { name: 'gemini-3-flash-preview', displayName: 'G3 Flash' }];

每个模型卡片显示：

*   模型名称（如 "G3 Pro"）
*   剩余时间（如 "3h 20m"，第一版显示 "Unknown"）
*   用量百分比（第一版显示 100%）

***

## Proposed Changes

### Types

#### \[MODIFY] index.ts

    interface GeminiAccount {  id: string;                    // UUID  email: string;                 // Google 邮箱  projectId: string;             // GCP 项目 ID  accessToken: string;  refreshToken: string;  expiresAt: number;             // 过期时间戳（毫秒）  isActive: boolean;  createdAt: string;}

#### \[MODIFY] package.json

更新插件名称、命令

***

### Services

#### \[NEW] GoogleAuthService.ts

本地 HTTP 服务器 (8085) → OAuth 回调 → 换取 tokens → 获取用户邮箱

#### \[NEW] GeminiCliService.ts

读写 `~/.gemini/settings.json`，注入凭证

***

### Managers

#### \[NEW] AccountManager.ts

多账号管理（VSCode globalState 存储）

#### \[NEW] TerminalManager.ts

杀终端 → 注入凭证 → 重启 gemini

***

### UI

#### \[MODIFY] SidebarProvider.ts

处理消息：`loginWithGoogle`、`switchAccount`、`removeAccount`

#### \[MODIFY] template.html

账号列表 + 操作按钮

#### \[MODIFY] script.js

UI 交互逻辑

***

## Verification

1.  **OAuth 登录** → 浏览器弹出 → 登录 → 账号入列表
2.  **多账号添加** → 列表显示多个账号
3.  **账号切换** → 终端销毁 → 凭证切换 → 终端重启
4.  **账号删除** → 从列表移除

